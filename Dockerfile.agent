FROM debian:trixie-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    git curl wget ca-certificates jq less vim-tiny procps \
    && rm -rf /var/lib/apt/lists/*

# Add Node.js for agent server
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/* \
    && corepack enable && corepack prepare pnpm@9.15.0 --activate

# Copy and build agent server
COPY agent-server/ /opt/agent-server/
RUN cd /opt/agent-server && pnpm install --prod

RUN useradd -m agent
USER agent
WORKDIR /home/agent

ENV PATH="/home/agent/.local/bin:${PATH}"

RUN curl -fsSL https://claude.ai/install.sh | bash

# Run agent server (stays alive, Claude CLI invoked on-demand by SDK)
ENTRYPOINT ["node", "/opt/agent-server/dist/index.js"]
